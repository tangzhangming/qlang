# Q è¯­è¨€æ•™ç¨‹ - å¹¶å‘ç¼–ç¨‹

## ç›®å½•

1. [å¹¶å‘æ¦‚è¿°](#å¹¶å‘æ¦‚è¿°)
2. [åç¨‹åŸºç¡€](#åç¨‹åŸºç¡€)
3. [go å…³é”®å­—](#go-å…³é”®å­—)
4. [Channel](#channel)
5. [å¹¶å‘æ¨¡å¼](#å¹¶å‘æ¨¡å¼)
6. [åŒæ­¥åŸè¯­](#åŒæ­¥åŸè¯­)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## å¹¶å‘æ¦‚è¿°

Q è¯­è¨€é‡‡ç”¨ Go é£æ ¼çš„å¹¶å‘æ¨¡å‹ï¼Œä½¿ç”¨åç¨‹ï¼ˆGoroutineï¼‰å’Œ Channel å®ç°é«˜æ•ˆçš„å¹¶å‘ç¼–ç¨‹ã€‚

### å¹¶å‘ vs å¹¶è¡Œ

- **å¹¶å‘ï¼ˆConcurrencyï¼‰**ï¼šå¤šä¸ªä»»åŠ¡å¯ä»¥åœ¨é‡å çš„æ—¶é—´æ®µå†…æ‰§è¡Œ
- **å¹¶è¡Œï¼ˆParallelismï¼‰**ï¼šå¤šä¸ªä»»åŠ¡åŒæ—¶åœ¨å¤šä¸ª CPU æ ¸å¿ƒä¸Šæ‰§è¡Œ

### Q è¯­è¨€çš„å¹¶å‘ç‰¹æ€§

- **è½»é‡çº§åç¨‹**ï¼šç±»ä¼¼ Go çš„ goroutineï¼Œå¯åŠ¨å¼€é”€å°
- **M:N è°ƒåº¦å™¨**ï¼šM ä¸ªåç¨‹æ˜ å°„åˆ° N ä¸ªç³»ç»Ÿçº¿ç¨‹
- **Channel é€šä¿¡**ï¼šé€šè¿‡ Channel åœ¨åç¨‹é—´å®‰å…¨ä¼ é€’æ•°æ®
- **GMP æ¨¡å‹**ï¼šGoroutine-Machine-Processor è°ƒåº¦æ¨¡å‹

---

## åç¨‹åŸºç¡€

### ä»€ä¹ˆæ˜¯åç¨‹

åç¨‹æ˜¯è½»é‡çº§çš„æ‰§è¡Œå•å…ƒï¼Œæ¯”çº¿ç¨‹æ›´è½»é‡ï¼š

- **åˆå§‹æ ˆå¤§å°**ï¼š2KBï¼ˆå¯å¢é•¿åˆ° 1MBï¼‰
- **åˆ›å»ºå¼€é”€**ï¼šæå°ï¼Œå¯åˆ›å»ºæ•°ç™¾ä¸‡ä¸ªåç¨‹
- **è°ƒåº¦å¼€é”€**ï¼šåä½œå¼è°ƒåº¦ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¿«

### åç¨‹çš„ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»º -> å°±ç»ª -> è¿è¡Œ -> é˜»å¡/ç­‰å¾… -> å®Œæˆ
```

---

## go å…³é”®å­—

ä½¿ç”¨ `go` å…³é”®å­—å¯åŠ¨æ–°çš„åç¨‹ã€‚

### åŸºæœ¬è¯­æ³•

```q
// å¯åŠ¨åç¨‹
go functionCall()
```

### å¯åŠ¨ç®€å•åç¨‹

```q
func sayHello(name: string) {
    println("Hello from coroutine: " + name)
}

// ä¸»çº¿ç¨‹
println("Main thread starts")

// å¯åŠ¨åç¨‹
go sayHello("Alice")
go sayHello("Bob")

println("Main thread continues")
```

å¯èƒ½çš„è¾“å‡ºï¼ˆé¡ºåºä¸ç¡®å®šï¼‰ï¼š
```
Main thread starts
Main thread continues
Hello from coroutine: Alice
Hello from coroutine: Bob
```

### ä½¿ç”¨é—­åŒ…å¯åŠ¨åç¨‹

```q
var count = 0

// å¯åŠ¨å¤šä¸ªåç¨‹
for var i = 0; i < 5; i++ {
    go func() {
        count += 1
        println("Count: " + count as string)
    }()
}

// æ³¨æ„ï¼šéœ€è¦åŒæ­¥æœºåˆ¶ç¡®ä¿æ‰€æœ‰åç¨‹æ‰§è¡Œå®Œæ¯•
```

### å¹¶å‘æ‰§è¡Œä»»åŠ¡

```q
var task1 = func() {
    for var i = 0; i < 3; i++ {
        println("Task 1: " + i as string)
    }
}

var task2 = func() {
    for var i = 0; i < 3; i++ {
        println("Task 2: " + i as string)
    }
}

// å¹¶å‘æ‰§è¡Œä¸¤ä¸ªä»»åŠ¡
go task1()
go task2()

// ä¸»çº¿ç¨‹ç­‰å¾…ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
println("All tasks started")
```

---

## Channel

Channel æ˜¯åç¨‹é—´é€šä¿¡çš„ç®¡é“ï¼Œç±»ä¼¼ Go çš„ channelã€‚

### åˆ›å»º Channel

```q
// åˆ›å»ºæ— ç¼“å†² Channelï¼ˆå½“å‰ç‰ˆæœ¬è¯­æ³•å¯èƒ½ç•¥æœ‰ä¸åŒï¼‰
// var ch = new Channel<int>()

// åˆ›å»ºå¸¦ç¼“å†² Channel
// var bufferedCh = new Channel<int>(10)
```

### Channel æ“ä½œï¼ˆè®¾è®¡æ¦‚å¿µï¼‰

è™½ç„¶å½“å‰ç‰ˆæœ¬å¯èƒ½æœªå®Œå…¨å®ç°ï¼Œä½†è®¾è®¡ä¸Šæ”¯æŒä»¥ä¸‹æ“ä½œï¼š

#### å‘é€æ•°æ®

```q
// ch.send(42)
```

#### æ¥æ”¶æ•°æ®

```q
// var value = ch.receive()
```

#### å…³é—­ Channel

```q
// ch.close()
```

#### æ£€æŸ¥æ˜¯å¦å…³é—­

```q
// if ch.isClosed() {
//     println("Channel is closed")
// }
```

### Channel çš„ç¼“å†²åŒº

#### æ— ç¼“å†² Channel

åŒæ­¥é€šä¿¡ï¼Œå‘é€æ–¹ä¼šé˜»å¡ç›´åˆ°æ¥æ”¶æ–¹æ¥æ”¶ï¼š

```q
// var ch = new Channel<int>()  // å®¹é‡ä¸º 0
// 
// go func() {
//     ch.send(42)  // é˜»å¡ï¼Œç›´åˆ°æœ‰æ¥æ”¶æ–¹
// }()
// 
// var value = ch.receive()  // æ¥æ”¶æ•°æ®
```

#### å¸¦ç¼“å†² Channel

å¼‚æ­¥é€šä¿¡ï¼Œç¼“å†²åŒºæœªæ»¡æ—¶å‘é€ä¸é˜»å¡ï¼š

```q
// var ch = new Channel<int>(3)  // å®¹é‡ä¸º 3
// 
// ch.send(1)  // ä¸é˜»å¡
// ch.send(2)  // ä¸é˜»å¡
// ch.send(3)  // ä¸é˜»å¡
// ch.send(4)  // é˜»å¡ï¼Œç¼“å†²åŒºå·²æ»¡
```

---

## å¹¶å‘æ¨¡å¼

### 1. ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

```q
var producer = func(ch: Channel<int>, n: int) {
    for var i = 0; i < n; i++ {
        // ch.send(i)
        println("Produced: " + i as string)
    }
    // ch.close()
}

var consumer = func(ch: Channel<int>) {
    // for value in ch {
    //     println("Consumed: " + value as string)
    // }
}

// var ch = new Channel<int>(5)
// go producer(ch, 10)
// consumer(ch)
```

### 2. Worker Pool æ¨¡å¼

```q
var worker = func(id: int, jobs: Channel<int>, results: Channel<int>) {
    // for job in jobs {
    //     println("Worker " + id as string + " processing job " + job as string)
    //     results.send(job * 2)
    // }
}

var workerPool = func(numWorkers: int, numJobs: int) {
    // var jobs = new Channel<int>(numJobs)
    // var results = new Channel<int>(numJobs)
    // 
    // // å¯åŠ¨ workers
    // for var i = 1; i <= numWorkers; i++ {
    //     go worker(i, jobs, results)
    // }
    // 
    // // å‘é€ä»»åŠ¡
    // for var j = 1; j <= numJobs; j++ {
    //     jobs.send(j)
    // }
    // jobs.close()
    // 
    // // æ”¶é›†ç»“æœ
    // for var k = 1; k <= numJobs; k++ {
    //     var result = results.receive()
    //     println("Result: " + result as string)
    // }
}

// workerPool(3, 9)
```

### 3. Pipeline æ¨¡å¼

```q
var generator = func(nums: int[]) Channel<int> {
    // var out = new Channel<int>()
    // 
    // go func() {
    //     for n in nums {
    //         out.send(n)
    //     }
    //     out.close()
    // }()
    // 
    // return out
}

var square = func(input: Channel<int>) Channel<int> {
    // var out = new Channel<int>()
    // 
    // go func() {
    //     for n in input {
    //         out.send(n * n)
    //     }
    //     out.close()
    // }()
    // 
    // return out
}

// ä½¿ç”¨ pipeline
// var nums = [1, 2, 3, 4, 5]
// var c1 = generator(nums)
// var c2 = square(c1)
// 
// for result in c2 {
//     println(result)
// }
```

### 4. Fan-Out/Fan-In æ¨¡å¼

```q
// Fan-Out: ä¸€ä¸ªè¾“å…¥ï¼Œå¤šä¸ªè¾“å‡º
var fanOut = func(input: Channel<int>, n: int) Channel<int>[] {
    var outputs: Channel<int>[] = []
    
    for var i = 0; i < n; i++ {
        // var ch = new Channel<int>()
        // outputs.append(ch)
        // 
        // go func(out: Channel<int>) {
        //     for val in input {
        //         out.send(val)
        //     }
        //     out.close()
        // }(ch)
    }
    
    return outputs
}

// Fan-In: å¤šä¸ªè¾“å…¥ï¼Œä¸€ä¸ªè¾“å‡º
var fanIn = func(channels: Channel<int>[]) Channel<int> {
    // var out = new Channel<int>()
    // 
    // for ch in channels {
    //     go func(c: Channel<int>) {
    //         for val in c {
    //             out.send(val)
    //         }
    //     }(ch)
    // }
    // 
    // return out
}
```

---

## åŒæ­¥åŸè¯­

### WaitGroupï¼ˆæ¦‚å¿µï¼‰

ç­‰å¾…ä¸€ç»„åç¨‹å®Œæˆï¼š

```q
// var wg = new WaitGroup()
// 
// for var i = 0; i < 5; i++ {
//     wg.add(1)
//     
//     go func(id: int) {
//         println("Goroutine " + id as string + " started")
//         // æ‰§è¡Œä»»åŠ¡...
//         println("Goroutine " + id as string + " finished")
//         wg.done()
//     }(i)
// }
// 
// wg.wait()  // ç­‰å¾…æ‰€æœ‰åç¨‹å®Œæˆ
// println("All goroutines completed")
```

### Mutexï¼ˆæ¦‚å¿µï¼‰

äº’æ–¥é”ä¿æŠ¤å…±äº«èµ„æºï¼š

```q
// var mutex = new Mutex()
// var counter = 0
// 
// var increment = func() {
//     mutex.lock()
//     counter += 1
//     mutex.unlock()
// }
// 
// // å¯åŠ¨å¤šä¸ªåç¨‹
// for var i = 0; i < 10; i++ {
//     go increment()
// }
```

### Channel ä½œä¸ºåŒæ­¥åŸè¯­

Channel æœ¬èº«å¯ä»¥ç”¨äºåŒæ­¥ï¼š

```q
var done = func() Channel<bool> {
    // var ch = new Channel<bool>()
    // 
    // go func() {
    //     // æ‰§è¡Œä¸€äº›å·¥ä½œ
    //     println("Work completed")
    //     ch.send(true)
    // }()
    // 
    // return ch
}

// var ch = done()
// var result = ch.receive()  // é˜»å¡ï¼Œç›´åˆ°å·¥ä½œå®Œæˆ
// println("Received completion signal")
```

---

## å®ç°çŠ¶æ€è¯´æ˜

**é‡è¦æç¤º**ï¼šQ è¯­è¨€çš„å¹¶å‘åŠŸèƒ½å½“å‰å¤„äºä»¥ä¸‹çŠ¶æ€ï¼š

### âœ… å·²å®ç°

1. **M:N åç¨‹è°ƒåº¦å™¨**ï¼šGMP æ¨¡å‹å®Œæ•´å®ç°
2. **go å…³é”®å­—è¯­æ³•**ï¼šå¯ä»¥å¯åŠ¨åç¨‹
3. **Channel åŸºç¡€æ¶æ„**ï¼šåº•å±‚ Channel å®ç°
4. **å·¥ä½œçªƒå–**ï¼šæ— é”æœ¬åœ°é˜Ÿåˆ— + å·¥ä½œçªƒå–
5. **åä½œå¼æŠ¢å **ï¼šå®‰å…¨ç‚¹æŠ¢å æœºåˆ¶

### ğŸš§ éƒ¨åˆ†å®ç°æˆ–è¯­æ³•å¯èƒ½ä¸åŒ

1. **Channel OOP API**ï¼š`new Channel<T>()` è¯­æ³•å¯èƒ½ä¸åŒ
2. **WaitGroup**ï¼šåº•å±‚å®ç°å­˜åœ¨ï¼Œä½† API å¯èƒ½ä¸åŒ
3. **Mutex/RWLock**ï¼šåŒæ­¥åŸè¯­çš„é«˜çº§ API

### å½“å‰å¯ç”¨åŠŸèƒ½

```q
// âœ… å¯ä»¥ä½¿ç”¨ go å¯åŠ¨åç¨‹
func sayHello(name: string) {
    println("Hello, " + name)
}

go sayHello("World")

// âœ… åç¨‹ä¸­æ‰§è¡Œå¤æ‚ä»»åŠ¡
go func() {
    for var i = 0; i < 5; i++ {
        println(i)
    }
}()
```

---

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå¹¶å‘è®¡ç®—

```q
var computeSum = func(numbers: int[], result: int) {
    var sum = 0
    for n in numbers {
        sum += n
    }
    println("Sum: " + sum as string)
}

var arr1 = [1, 2, 3, 4, 5]
var arr2 = [10, 20, 30, 40, 50]

// å¹¶å‘è®¡ç®—ä¸¤ä¸ªæ•°ç»„çš„å’Œ
go computeSum(arr1, 0)
go computeSum(arr2, 0)

println("Calculations started")
```

### ç¤ºä¾‹ 2ï¼šå¹¶å‘ä»»åŠ¡è°ƒåº¦

```q
var task = func(id: int, duration: int) {
    println("Task " + id as string + " started")
    
    // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    for var i = 0; i < duration; i++ {
        // æ‰§è¡Œå·¥ä½œ
    }
    
    println("Task " + id as string + " completed")
}

// å¯åŠ¨å¤šä¸ªå¹¶å‘ä»»åŠ¡
for var i = 0; i < 5; i++ {
    go task(i, 100)
}

println("All tasks scheduled")
```

### ç¤ºä¾‹ 3ï¼šé€’å½’æ–æ³¢é‚£å¥‘ï¼ˆå¹¶å‘ç‰ˆï¼‰

```q
var fib = func(n: int) int {
    if n <= 1 {
        return n
    }
    return fib(n - 1) + fib(n - 2)
}

// å¹¶å‘è®¡ç®—å¤šä¸ªæ–æ³¢é‚£å¥‘æ•°
for var i = 1; i <= 10; i++ {
    go func(n: int) {
        var result = fib(n)
        println("fib(" + n as string + ") = " + result as string)
    }(i)
}
```

---

## æœ€ä½³å®è·µ

### 1. é¿å…å…±äº«çŠ¶æ€

```q
// ä¸å¥½ï¼šå…±äº«å˜é‡ï¼ˆéœ€è¦é”ï¼‰
var counter = 0

go func() {
    counter += 1  // ç«æ€æ¡ä»¶
}()

// å¥½ï¼šä½¿ç”¨ Channel é€šä¿¡
// var ch = new Channel<int>()
// go func() {
//     ch.send(1)
// }()
```

### 2. ä¸è¦æ³„éœ²åç¨‹

```q
// ä¸å¥½ï¼šåç¨‹å¯èƒ½æ°¸è¿œé˜»å¡
// var leak = func() {
//     var ch = new Channel<int>()
//     go func() {
//         ch.receive()  // å¦‚æœæ²¡æœ‰å‘é€ï¼Œä¼šæ°¸è¿œé˜»å¡
//     }()
// }

// å¥½ï¼šç¡®ä¿åç¨‹èƒ½å¤Ÿé€€å‡º
// var noLeak = func() {
//     var ch = new Channel<int>()
//     go func() {
//         // ä½¿ç”¨è¶…æ—¶æˆ–å…³é—­ä¿¡å·
//     }()
//     ch.close()
// }
```

### 3. Channel çš„æ–¹å‘æ€§

```q
// è®¾è®¡æ¥å£æ—¶æ˜ç¡® Channel æ–¹å‘ï¼ˆè®¾è®¡æ¦‚å¿µï¼‰
// func producer(out: Channel<int>) {
//     // åªå‘é€
// }
// 
// func consumer(input: Channel<int>) {
//     // åªæ¥æ”¶
// }
```

### 4. é€‚å½“çš„ç¼“å†²åŒºå¤§å°

```q
// æ— ç¼“å†²ï¼šéœ€è¦ç²¾ç¡®åŒæ­¥
// var sync = new Channel<int>()

// ç¼“å†² = 1ï¼šå•ä¸ªå€¼çš„ä¿¡å·é‡
// var signal = new Channel<int>(1)

// ç¼“å†² = Nï¼šæµæ§åˆ¶
// var stream = new Channel<int>(100)
```

### 5. ä¼˜é›…é€€å‡º

```q
// ä½¿ç”¨å…³é—­ä¿¡å·ä¼˜é›…é€€å‡º
// var done = new Channel<bool>()
// 
// go func() {
//     for {
//         // æ£€æŸ¥é€€å‡ºä¿¡å·
//         if done.tryReceive() != null {
//             break
//         }
//         // æ‰§è¡Œå·¥ä½œ
//     }
// }()
// 
// // å‘é€é€€å‡ºä¿¡å·
// done.send(true)
```

---

## å¹¶å‘é™·é˜±

### 1. ç«æ€æ¡ä»¶

```q
// é”™è¯¯ï¼šå¤šä¸ªåç¨‹åŒæ—¶ä¿®æ”¹
var count = 0

for var i = 0; i < 10; i++ {
    go func() {
        count += 1  // ç«æ€æ¡ä»¶ï¼
    }()
}
```

### 2. æ­»é”

```q
// é”™è¯¯ï¼šç›¸äº’ç­‰å¾…
// var ch1 = new Channel<int>()
// var ch2 = new Channel<int>()
// 
// go func() {
//     ch1.send(1)
//     ch2.receive()  // ç­‰å¾… ch2
// }()
// 
// go func() {
//     ch2.send(2)
//     ch1.receive()  // ç­‰å¾… ch1
// }()
// 
// // æ­»é”ï¼ä¸¤ä¸ªåç¨‹ç›¸äº’ç­‰å¾…
```

### 3. åç¨‹æ³„éœ²

```q
// é”™è¯¯ï¼šåç¨‹æ°¸è¿œä¸ä¼šç»“æŸ
// go func() {
//     for {
//         // æ²¡æœ‰é€€å‡ºæ¡ä»¶
//     }
// }()
```

---

## æ€§èƒ½ç›®æ ‡

Q è¯­è¨€çš„å¹¶å‘ç³»ç»Ÿè®¾è®¡ç›®æ ‡ï¼š

| æŒ‡æ ‡ | ç›®æ ‡å€¼ |
|------|--------|
| åç¨‹åˆ›å»ºé€Ÿåº¦ | > 1M/s |
| ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶é—´ | < 100ns |
| åç¨‹åˆå§‹å†…å­˜ | 2-4KB |
| Channel ååé‡ | > 10M msg/s |

---

## ä¸‹ä¸€æ­¥

- å­¦ä¹  [Trait](./Trait.md)
- å­¦ä¹  [é”™è¯¯å¤„ç†](./é”™è¯¯å¤„ç†.md)
- å­¦ä¹  [å‡½æ•°è¿›é˜¶](./å‡½æ•°è¿›é˜¶.md)
