# Q 语言教程 - 运算符

## 目录

1. [算术运算符](#算术运算符)
2. [比较运算符](#比较运算符)
3. [逻辑运算符](#逻辑运算符)
4. [位运算符](#位运算符)
5. [赋值运算符](#赋值运算符)
6. [自增自减运算符](#自增自减运算符)
7. [成员访问运算符](#成员访问运算符)
8. [其他运算符](#其他运算符)
9. [运算符优先级](#运算符优先级)

---

## 算术运算符

### 基本算术运算

```q
var a = 10
var b = 3

// 加法
var sum = a + b         // 13

// 减法
var diff = a - b        // 7

// 乘法
var prod = a * b        // 30

// 除法
var quot = a / b        // 3（整数除法）

// 取模
var rem = a % b         // 1
```

### 浮点数运算

```q
var x = 10.0
var y = 3.0

var div = x / y         // 3.333...
var mod = x % y         // 1.0
```

### 负号（一元运算符）

```q
var num = 10
var neg = -num          // -10

var positive = -(-10)   // 10
```

### 混合类型运算

```q
var intVal = 10
var floatVal = 3.5

// 需要显式类型转换
var result = (intVal as f64) + floatVal  // 13.5
```

---

## 比较运算符

比较运算符返回 `bool` 类型。

### 相等性比较

```q
var a = 10
var b = 20

// 等于
var eq = a == b         // false

// 不等于
var ne = a != b         // true
```

### 关系比较

```q
var x = 5
var y = 10

// 小于
var lt = x < y          // true

// 小于等于
var le = x <= y         // true

// 大于
var gt = x > y          // false

// 大于等于
var ge = x >= y         // false
```

### 字符串比较

```q
var str1 = "abc"
var str2 = "xyz"

var same = str1 == str2      // false
var diff = str1 != str2      // true
```

### 布尔比较

```q
var flag1 = true
var flag2 = false

var result1 = flag1 == true  // true
var result2 = flag1 != flag2 // true
```

---

## 逻辑运算符

### 逻辑与 (&&)

两个操作数都为 `true` 时返回 `true`：

```q
var a = true
var b = false

var result1 = a && b     // false
var result2 = a && true  // true
var result3 = false && b // false
```

### 逻辑或 (||)

任一操作数为 `true` 时返回 `true`：

```q
var a = true
var b = false

var result1 = a || b     // true
var result2 = false || b // false
var result3 = false || false // false
```

### 逻辑非 (!)

取反操作：

```q
var flag = true

var notFlag = !flag      // false
var doubleNot = !!flag   // true
```

### 短路求值

逻辑运算符支持短路求值：

```q
var x = 0

// && 短路：左边为 false，不计算右边
if x != 0 && 100 / x > 5 {
    println("不会到达这里")
}
// 由于 x != 0 为 false，不会执行 100 / x（避免除零错误）

// || 短路：左边为 true，不计算右边
var name = ""
if name == "" || name == "default" {
    println("使用默认名称")
}
// 由于 name == "" 为 true，不会计算后面的条件
```

### 复杂逻辑表达式

```q
var age = 25
var hasLicense = true
var isEmployed = false

var canDrive = age >= 18 && hasLicense
var needsJob = !isEmployed || age < 25

if (age >= 18 && hasLicense) && (isEmployed || age < 30) {
    println("符合条件")
}
```

---

## 位运算符

位运算符对整数的二进制位进行操作。

### 按位与 (&)

```q
var a = 12  // 1100
var b = 10  // 1010

var result = a & b  // 1000 = 8
println(result)     // 8
```

### 按位或 (|)

```q
var a = 12  // 1100
var b = 10  // 1010

var result = a | b  // 1110 = 14
println(result)     // 14
```

### 按位异或 (^)

```q
var a = 12  // 1100
var b = 10  // 1010

var result = a ^ b  // 0110 = 6
println(result)     // 6
```

### 按位取反 (~)

```q
var a = 12  // 00001100

var result = ~a  // 11110011 (补码表示)
```

### 左移 (<<)

```q
var a = 5   // 0101

var result1 = a << 1  // 1010 = 10
var result2 = a << 2  // 10100 = 20

println(result1)  // 10
println(result2)  // 20
```

### 右移 (>>)

```q
var a = 20  // 10100

var result1 = a >> 1  // 01010 = 10
var result2 = a >> 2  // 00101 = 5

println(result1)  // 10
println(result2)  // 5
```

### 位运算应用

```q
// 检查奇偶
var isOdd = func(n: int) bool {
    return (n & 1) == 1
}

// 乘以 2 的幂
var multiplyBy4 = func(n: int) int {
    return n << 2
}

// 除以 2 的幂
var divideBy8 = func(n: int) int {
    return n >> 3
}

println(isOdd(7))        // true
println(multiplyBy4(5))  // 20
println(divideBy8(32))   // 4
```

---

## 赋值运算符

### 简单赋值 (=)

```q
var x = 10
var y = 20

x = y       // x 现在是 20
y = 30      // y 现在是 30
```

### 复合赋值运算符

#### 算术复合赋值

```q
var x = 10

x += 5      // x = x + 5  => 15
x -= 3      // x = x - 3  => 12
x *= 2      // x = x * 2  => 24
x /= 4      // x = x / 4  => 6
x %= 4      // x = x % 4  => 2
```

#### 位运算复合赋值

```q
var flags = 12  // 1100

flags &= 10     // flags = flags & 10  => 8
flags |= 5      // flags = flags | 5   => 13
flags ^= 7      // flags = flags ^ 7   => 10
flags <<= 1     // flags = flags << 1  => 20
flags >>= 2     // flags = flags >> 2  => 5
```

### 链式赋值

```q
var a: int
var b: int
var c: int

// 注意：Q 语言可能不支持链式赋值
// a = b = c = 10

// 推荐写法
var value = 10
a = value
b = value
c = value
```

---

## 自增自减运算符

Q 语言只支持后缀形式的自增自减。

### 后缀自增 (++)

```q
var count = 0

count++     // count = count + 1
println(count)  // 1

count++
println(count)  // 2
```

### 后缀自减 (--)

```q
var count = 10

count--     // count = count - 1
println(count)  // 9

count--
println(count)  // 8
```

### 在表达式中使用

```q
var x = 5
var y = x++     // y = 5, x = 6（先赋值，后自增）

var a = 10
var b = a--     // b = 10, a = 9（先赋值，后自减）
```

### 循环中使用

```q
// for 循环
for var i = 0; i < 10; i++ {
    println(i)
}

// while 循环
var count = 5
for count > 0 {
    println(count)
    count--
}
```

---

## 成员访问运算符

### 点运算符 (.)

访问对象的字段和方法：

```q
class Person {
    func init(var name: string, var age: int) {}
    
    func greet() {
        println("Hello, " + this.name)
    }
}

var person = new Person("Alice", 25)

// 访问字段
println(person.name)    // Alice
println(person.age)     // 25

// 调用方法
person.greet()          // Hello, Alice
```

### 索引运算符 ([])

访问数组、切片的元素：

```q
var numbers = [10, 20, 30, 40, 50]

// 读取元素
var first = numbers[0]   // 10
var last = numbers[4]    // 50

// 修改元素
numbers[2] = 99
println(numbers[2])      // 99
```

### 静态成员访问 (::)

访问类的静态成员：

```q
class MathHelper {
    static const PI: f64 = 3.14159
    
    static func max(a: int, b: int) int {
        if a > b {
            return a
        }
        return b
    }
}

// 访问静态常量
var pi = MathHelper::PI

// 调用静态方法
var maximum = MathHelper::max(10, 20)
```

---

## 其他运算符

### 范围运算符 (..)

创建范围，用于 for 循环：

```q
// 不含结束值
for i in 0..10 {
    println(i)  // 0 到 9
}

// 包含结束值
for i in 0..=10 {
    println(i)  // 0 到 10
}

// 倒序
for i in 10..0 {
    println(i)  // 10 到 1
}
```

### 类型转换 (as)

显式类型转换：

```q
var intVal = 42
var floatVal = intVal as f64    // 42.0

var f = 3.14
var i = f as int                // 3（截断）

var small: i32 = 100
var large: i64 = small as i64   // 扩展转换
```

### 类型检查 (is)

检查值的类型：

```q
var value: unknown = 42

if value is int {
    println("It's an integer")
}

if value is string {
    println("It's a string")
} else {
    println("Not a string")
}
```

### 函数调用 (())

```q
var add = func(a: int, b: int) int {
    return a + b
}

var result = add(10, 20)  // 函数调用
println(result)           // 30
```

---

## 运算符优先级

从高到低：

| 优先级 | 运算符 | 描述 |
|--------|--------|------|
| 1 | `()` `[]` `.` `::` | 分组、索引、成员访问 |
| 2 | `++` `--` (后缀) | 后缀自增自减 |
| 3 | `!` `~` `-` (一元) | 逻辑非、按位取反、负号 |
| 4 | `*` `/` `%` | 乘、除、取模 |
| 5 | `+` `-` | 加、减 |
| 6 | `<<` `>>` | 位移 |
| 7 | `<` `<=` `>` `>=` | 关系比较 |
| 8 | `==` `!=` | 相等性比较 |
| 9 | `&` | 按位与 |
| 10 | `^` | 按位异或 |
| 11 | `|` | 按位或 |
| 12 | `&&` | 逻辑与 |
| 13 | `||` | 逻辑或 |
| 14 | `as` `is` | 类型运算 |
| 15 | `=` `+=` `-=` `*=` `/=` 等 | 赋值 |

### 优先级示例

```q
// 乘法优先于加法
var result1 = 2 + 3 * 4     // 14（不是 20）

// 使用括号改变优先级
var result2 = (2 + 3) * 4   // 20

// 比较优先于逻辑运算
var result3 = true || false && false  // true
// 等价于: true || (false && false)

// 位运算与逻辑运算
var result4 = 5 & 3 == 1    // false
// 等价于: 5 & (3 == 1)，即 5 & false（类型错误）

var result5 = (5 & 3) == 1  // true
```

---

## 运算符组合

### 算术与比较

```q
var age = 25
var isAdult = age >= 18        // true

var score = 85
var isPassing = score >= 60    // true

var total = 100
var half = total / 2
var isMore = half > 40         // true
```

### 逻辑组合

```q
var age = 25
var hasLicense = true
var hasInsurance = true

// 复杂条件
var canDrive = (age >= 18) && hasLicense && hasInsurance

var x = 10
var y = 20
var z = 30

// 范围检查
var inRange = (x > 0 && x < 100) && (y > 0 && y < 100)

// 多条件
var isValid = (z >= 10) && (z <= 50) || (z == 100)
```

### 位运算组合

```q
// 权限标志
const READ = 1      // 001
const WRITE = 2     // 010
const EXECUTE = 4   // 100

var permission = READ | WRITE  // 011 = 3

// 检查权限
var canRead = (permission & READ) != 0      // true
var canWrite = (permission & WRITE) != 0    // true
var canExecute = (permission & EXECUTE) != 0  // false

// 添加权限
permission = permission | EXECUTE  // 111 = 7

// 移除权限
permission = permission & ~WRITE   // 101 = 5
```

---

## 完整示例

### 示例 1：计算器

```q
class Calculator {
    static func add(a: int, b: int) int {
        return a + b
    }
    
    static func subtract(a: int, b: int) int {
        return a - b
    }
    
    static func multiply(a: int, b: int) int {
        return a * b
    }
    
    static func divide(a: int, b: int) int {
        if b == 0 {
            panic("Division by zero")
        }
        return a / b
    }
    
    static func modulo(a: int, b: int) int {
        return a % b
    }
}

var x = 20
var y = 3

println(Calculator::add(x, y))       // 23
println(Calculator::subtract(x, y))  // 17
println(Calculator::multiply(x, y))  // 60
println(Calculator::divide(x, y))    // 6
println(Calculator::modulo(x, y))    // 2
```

### 示例 2：位标志管理

```q
class FilePermission {
    static const READ: int = 1      // 001
    static const WRITE: int = 2     // 010
    static const EXECUTE: int = 4   // 100
    
    static func hasRead(perm: int) bool {
        return (perm & FilePermission::READ) != 0
    }
    
    static func hasWrite(perm: int) bool {
        return (perm & FilePermission::WRITE) != 0
    }
    
    static func hasExecute(perm: int) bool {
        return (perm & FilePermission::EXECUTE) != 0
    }
    
    static func addPermission(perm: int, flag: int) int {
        return perm | flag
    }
    
    static func removePermission(perm: int, flag: int) int {
        return perm & ~flag
    }
}

var perm = FilePermission::READ | FilePermission::WRITE

println(FilePermission::hasRead(perm))     // true
println(FilePermission::hasExecute(perm))  // false

perm = FilePermission::addPermission(perm, FilePermission::EXECUTE)
println(FilePermission::hasExecute(perm))  // true
```

### 示例 3：表达式求值

```q
var evaluate = func() {
    // 算术运算
    var result1 = (10 + 20) * 3 - 15 / 5    // 87
    
    // 逻辑运算
    var result2 = (5 > 3) && (10 < 20)      // true
    
    // 混合运算
    var x = 10
    var result3 = x >= 5 && x <= 15         // true
    
    // 位运算
    var result4 = (12 & 10) | (5 ^ 3)       // 8 | 6 = 14
    
    println(result1)
    println(result2)
    println(result3)
    println(result4)
}

evaluate()
```

---

## 最佳实践

1. **使用括号增强可读性**：复杂表达式使用括号明确优先级
2. **避免过度复杂的表达式**：将复杂表达式分解为多个简单语句
3. **利用短路求值**：将开销大的条件放在后面
4. **位运算用于标志**：使用位运算管理多个布尔标志
5. **注意整数除法**：整数相除会截断小数部分
6. **类型转换要明确**：不依赖隐式转换，显式使用 `as`

---

## 下一步

- 学习 [变量和常量](./变量和常量.md)
- 学习 [类型系统进阶](./类型系统进阶.md)
- 学习 [控制结构](./控制结构.md)
