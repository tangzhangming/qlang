# Q 语言教程 - 控制结构

## 目录

1. [if 语句](#if-语句)
2. [for 循环](#for-循环)
3. [break 和 continue](#break-和-continue)
4. [match 表达式](#match-表达式)
5. [函数和闭包](#函数和闭包)

---

## if 语句

### 基本形式

```q
var age = 18

if age >= 18 {
    println("成年人")
}
```

### if-else

```q
var score = 75

if score >= 60 {
    println("及格")
} else {
    println("不及格")
}
```

### if-else if-else

```q
var score = 85

if score >= 90 {
    println("优秀")
} else if score >= 80 {
    println("良好")
} else if score >= 60 {
    println("及格")
} else {
    println("不及格")
}
```

### 条件表达式

括号是可选的：

```q
// 带括号
if (x > 0) {
    println("正数")
}

// 不带括号
if x > 0 {
    println("正数")
}
```

---

## for 循环

Q 语言提供了多种形式的 `for` 循环。

### C 风格循环

```q
// 基本形式
for var i = 0; i < 10; i += 1 {
    println(i)
}

// i++ 和 i-- 也支持
for var i = 0; i < 10; i++ {
    println(i)
}

// 倒序
for var i = 10; i > 0; i-- {
    println(i)
}
```

### 条件循环

```q
var count = 0

// 类似其他语言的 while
for count < 10 {
    println(count)
    count += 1
}
```

### 无限循环

```q
for {
    println("无限循环")
    
    // 需要 break 退出
    if someCondition {
        break
    }
}
```

### Range 循环

使用 `..` 或 `..=` 创建范围：

```q
// 0 到 9（不含 10）
for i in 0..10 {
    println(i)
}

// 0 到 10（含 10）
for i in 0..=10 {
    println(i)
}

// 倒序（从 10 到 1）
for i in 10..0 {
    println(i)
}
```

### 遍历数组/切片

```q
var numbers = [1, 2, 3, 4, 5]

// 只遍历值
for num in numbers {
    println(num)
}

// 遍历索引和值
for i, num in numbers {
    print("Index: ")
    print(i)
    print(", Value: ")
    println(num)
}
```

### 遍历 Map

```q
var ages = {
    "Alice": 25,
    "Bob": 30,
    "Charlie": 28
}

// 遍历键和值
for name, age in ages {
    print(name)
    print(": ")
    println(age)
}
```

---

## break 和 continue

### break

`break` 用于退出循环：

```q
for var i = 0; i < 10; i++ {
    if i == 5 {
        break  // 退出循环
    }
    println(i)
}
// 输出：0 1 2 3 4
```

### continue

`continue` 用于跳过当前迭代，继续下一次迭代：

```q
for var i = 0; i < 10; i++ {
    if i % 2 == 0 {
        continue  // 跳过偶数
    }
    println(i)
}
// 输出：1 3 5 7 9
```

### 带标签的循环

对于嵌套循环，可以使用标签来指定要跳出或继续的循环：

```q
outer: for var i = 0; i < 5; i++ {
    for var j = 0; j < 5; j++ {
        if i * j > 6 {
            break outer  // 跳出外层循环
        }
        print(i * j)
        print(" ")
    }
}
```

---

## match 表达式

`match` 表达式类似其他语言的 `switch`，但更强大。

### 基本匹配

```q
var status = 200

match status {
    200 => {
        println("OK")
    }
    404 => {
        println("Not Found")
    }
    500 => {
        println("Internal Server Error")
    }
    _ => {
        println("Unknown Status")
    }
}
```

### match 作为表达式

`match` 可以返回值：

```q
var status = 200

var message = match status {
    200 => "OK"
    404 => "Not Found"
    500 => "Internal Server Error"
    _ => "Unknown"
}

println(message)  // 输出：OK
```

### 多值匹配

```q
var code = 2

match code {
    1, 2, 3 => {
        println("Low number")
    }
    4, 5, 6 => {
        println("Medium number")
    }
    _ => {
        println("Other")
    }
}
```

### 范围匹配

```q
var age = 25

match age {
    0..18 => {
        println("未成年")
    }
    18..60 => {
        println("成年人")
    }
    _ => {
        println("老年人")
    }
}
```

### 守卫条件

使用 `if` 添加额外条件：

```q
var num = 15

match num {
    n if n < 0 => println("负数")
    n if n == 0 => println("零")
    n if n > 0 && n <= 10 => println("小正数")
    n if n > 10 => println("大正数")
    _ => println("其他")
}
```

### 类型匹配

```q
var value: unknown = 42

match value {
    x: int => {
        print("整数：")
        println(x)
    }
    s: string => {
        print("字符串：")
        println(s)
    }
    _ => {
        println("其他类型")
    }
}
```

---

## 函数和闭包

### 闭包定义

Q 语言中的所有函数都是闭包，通过 `func` 关键字定义并赋值给变量：

```q
// 无返回值函数
var sayHello = func() {
    println("Hello!")
}

// 调用函数
sayHello()
```

### 带参数的函数

```q
var add = func(a: int, b: int) int {
    return a + b
}

var result = add(10, 20)
println(result)  // 30
```

### 多返回值

Q 语言支持多返回值：

```q
var divmod = func(a: int, b: int) (int, int) {
    return a / b, a % b
}

// 必须解构接收
var quotient, remainder = divmod(10, 3)
println(quotient)   // 3
println(remainder)  // 1
```

### 默认参数

```q
var greet = func(name: string, greeting: string = "Hello") string {
    return greeting + ", " + name + "!"
}

println(greet("Alice"))          // "Hello, Alice!"
println(greet("Bob", "Hi"))      // "Hi, Bob!"
```

### 可变参数

使用 `...` 声明可变参数：

```q
var sum = func(numbers: int...) int {
    var total = 0
    for n in numbers {
        total += n
    }
    return total
}

println(sum(1, 2, 3))          // 6
println(sum(1, 2, 3, 4, 5))    // 15
```

### 闭包捕获

闭包可以捕获外部变量：

```q
var makeCounter = func() func() int {
    var count = 0
    return func() int {
        count += 1
        return count
    }
}

var counter = makeCounter()
println(counter())  // 1
println(counter())  // 2
println(counter())  // 3
```

### 递归函数

闭包可以通过变量名调用自己：

```q
var factorial = func(n: int) int {
    if n <= 1 {
        return 1
    }
    return n * factorial(n - 1)
}

println(factorial(5))  // 120
```

### 高阶函数

函数可以作为参数和返回值：

```q
// 函数作为参数
var apply = func(a: int, b: int, op: func(int, int) int) int {
    return op(a, b)
}

var multiply = func(a: int, b: int) int {
    return a * b
}

var result = apply(3, 4, multiply)
println(result)  // 12

// 函数作为返回值
var makeAdder = func(n: int) func(int) int {
    return func(x: int) int {
        return x + n
    }
}

var add5 = makeAdder(5)
println(add5(10))  // 15
```

### 匿名函数

可以直接创建匿名函数并立即调用：

```q
var result = (func(x: int) int {
    return x * 2
})(21)

println(result)  // 42
```

---

## return 语句

### 基本 return

```q
var max = func(a: int, b: int) int {
    if a > b {
        return a
    }
    return b
}
```

### 提前返回

```q
var divide = func(a: int, b: int) int {
    if b == 0 {
        println("错误：除数为零")
        return 0
    }
    return a / b
}
```

### void 函数的 return

```q
var printPositive = func(n: int) {
    if n <= 0 {
        return  // 直接返回，不带值
    }
    println(n)
}
```

---

## 逻辑短路

逻辑运算符 `&&` 和 `||` 支持短路求值：

### && 短路

```q
var x = 0

// 只有左边为 true 时才会计算右边
if x != 0 && 100 / x > 5 {
    println("不会执行")
}
// 由于 x != 0 为 false，不会执行 100 / x（避免除零错误）
```

### || 短路

```q
var name = ""

// 只有左边为 false 时才会计算右边
if name == "" || name == "default" {
    println("使用默认名称")
}
// 由于 name == "" 为 true，不会计算后面的条件
```

---

## 作用域

### 块作用域

Q 语言支持块级作用域：

```q
var x = 10

if true {
    var y = 20
    println(x)  // 可以访问外部变量
    println(y)  // 20
}

// println(y)  // 错误：y 在此处不可见
```

### 变量遮蔽

**重要**：Q 语言不允许在同一函数内的不同作用域中声明同名变量：

```q
var greeting = func() {
    var x = 10
    
    if true {
        // var x = 20  // 错误！不允许遮蔽外层变量
        x = 20         // 正确：修改外层变量
    }
    
    println(x)  // 20
}
```

---

## 最佳实践

1. **使用 match 而非多个 if-else**：当有多个条件分支时，`match` 更清晰
2. **利用短路求值**：可以避免不必要的计算和潜在错误
3. **提前返回**：对于错误情况，尽早返回可以减少嵌套
4. **给复杂循环添加标签**：嵌套循环中使用标签可以使代码意图更明确
5. **闭包捕获变量**：注意闭包会延长被捕获变量的生命周期
6. **合理使用多返回值**：对于需要返回多个相关值的函数很有用

---

## 完整示例

### 示例 1：查找最大值

```q
var findMax = func(numbers: int[]) int {
    if numbers == [] {
        return 0
    }
    
    var max = numbers[0]
    for num in numbers {
        if num > max {
            max = num
        }
    }
    return max
}

var nums = [5, 2, 9, 1, 7]
println(findMax(nums))  // 9
```

### 示例 2：阶乘计算

```q
var factorial = func(n: int) int {
    if n <= 1 {
        return 1
    }
    return n * factorial(n - 1)
}

for var i = 1; i <= 5; i++ {
    println(factorial(i))
}
// 输出：1, 2, 6, 24, 120
```

### 示例 3：FizzBuzz

```q
for var i = 1; i <= 20; i++ {
    var output = match i % 15 {
        0 => "FizzBuzz"
        3, 6, 9, 12 => "Fizz"
        5, 10 => "Buzz"
        _ => ""
    }
    
    if output == "" {
        println(i)
    } else {
        println(output)
    }
}
```

---

## 下一步

- 学习 [基本类型](./基本类型.md)
- 学习 [结构体](./结构体.md)
- 学习 [面向对象](./面向对象.md)
