# Q 语言教程 - 结构体

## 目录

1. [结构体基础](#结构体基础)
2. [结构体字段](#结构体字段)
3. [结构体方法](#结构体方法)
4. [结构体实例化](#结构体实例化)
5. [静态成员](#静态成员)
6. [结构体实现接口](#结构体实现接口)
7. [值类型特性](#值类型特性)

---

## 结构体基础

结构体（struct）是值类型，用于组合多个相关数据。结构体分配在栈上，性能高效。

### 基本定义

```q
struct Point {
    x: int
    y: int
}
```

### 完整示例

```q
struct Person {
    name: string
    age: int
    email: string
}
```

---

## 结构体字段

### 字段声明

```q
struct Rectangle {
    x: int
    y: int
    width: int
    height: int
}
```

### 字段类型

结构体字段可以是任何类型：

```q
struct Employee {
    id: int
    name: string
    salary: f64
    active: bool
    skills: string[]
}
```

### 字段访问

```q
struct Point {
    x: int
    y: int
}

var p = Point { x: 10, y: 20 }

// 读取字段
println(p.x)  // 10
println(p.y)  // 20

// 修改字段
p.x = 30
p.y = 40
```

---

## 结构体方法

结构体可以定义方法。在方法中使用 `this` 访问结构体实例。

### 实例方法

```q
struct Point {
    x: int
    y: int
    
    func distanceFromOrigin() f64 {
        var dx = this.x as f64
        var dy = this.y as f64
        // 简化计算（实际应该用 sqrt）
        return dx * dx + dy * dy
    }
    
    func print() {
        print("Point(")
        print(this.x)
        print(", ")
        print(this.y)
        println(")")
    }
}

// 使用
var p = Point { x: 3, y: 4 }
p.print()  // 输出：Point(3, 4)
```

### 方法修改字段

```q
struct Counter {
    count: int
    
    func increment() {
        this.count += 1
    }
    
    func reset() {
        this.count = 0
    }
    
    func getValue() int {
        return this.count
    }
}

var c = Counter { count: 0 }
c.increment()
c.increment()
println(c.getValue())  // 2
```

---

## 结构体实例化

Q 语言提供多种方式创建结构体实例。

### 字段初始化器

使用花括号直接初始化字段：

```q
struct Point {
    x: int
    y: int
}

var p1 = Point { x: 10, y: 20 }
var p2 = Point { x: 0, y: 0 }
```

### 所有字段都必须初始化

```q
struct Person {
    name: string
    age: int
}

// 正确：所有字段都初始化了
var person = Person { name: "Alice", age: 25 }

// 错误：缺少字段（编译错误）
// var person2 = Person { name: "Bob" }
```

---

## 静态成员

**注意**：当前版本的 Q 语言结构体不支持静态方法和静态常量。静态成员只能在类中使用。

如果需要静态功能，请使用类而非结构体：

```q
class MathHelper {
    static func max(a: int, b: int) int {
        if a > b {
            return a
        }
        return b
    }
}

var result = MathHelper::max(10, 20)
```

---

## 结构体实现接口

结构体可以实现接口，提供多态能力。

### 定义接口

```q
interface Printable {
    func print()
}
```

### 结构体实现接口

```q
struct Point implements Printable {
    x: int
    y: int
    
    func print() {
        println("Point: printing")
    }
}

var p = Point { x: 10, y: 20 }
p.print()  // 输出：Point: printing
```

### 实现多个接口

```q
interface Drawable {
    func draw()
}

interface Resizable {
    func resize(width: int, height: int)
}

struct Rectangle implements Drawable, Resizable {
    x: int
    y: int
    width: int
    height: int
    
    func draw() {
        println("Drawing rectangle")
    }
    
    func resize(width: int, height: int) {
        this.width = width
        this.height = height
    }
}
```

---

## 值类型特性

结构体是值类型，这意味着：

### 栈分配

结构体实例分配在栈上，效率高：

```q
struct Point {
    x: int
    y: int
}

var p = Point { x: 10, y: 20 }  // 在栈上分配
```

### 赋值时复制

结构体赋值会创建副本：

```q
struct Point {
    x: int
    y: int
}

var p1 = Point { x: 10, y: 20 }
var p2 = p1  // 复制 p1 到 p2

p2.x = 30

println(p1.x)  // 10（p1 没有改变）
println(p2.x)  // 30
```

### 传递给函数

将结构体传递给函数时会复制：

```q
struct Point {
    x: int
    y: int
}

var modify = func(p: Point) {
    p.x = 100  // 修改的是副本
}

var original = Point { x: 10, y: 20 }
modify(original)

println(original.x)  // 10（原始值未改变）
```

---

## 结构体与类的区别

### 结构体（Struct）

- **值类型**：分配在栈上
- **赋值复制**：赋值时创建副本
- **无继承**：不支持继承
- **可实现接口**：支持接口实现
- **无构造函数**：使用字段初始化器
- **轻量级**：适合小型、简单的数据结构

### 类（Class）

- **引用类型**：分配在堆上
- **赋值引用**：赋值时共享引用
- **支持继承**：可以继承其他类
- **可实现接口**：支持接口实现
- **有构造函数**：支持 `init()` 方法
- **重量级**：适合复杂的对象

### 何时使用结构体

- 数据量小（通常小于几十字节）
- 逻辑上表示单个值
- 不需要继承
- 希望值语义（赋值时复制）

示例：

```q
// 适合用结构体：简单的坐标
struct Point {
    x: int
    y: int
}

// 适合用结构体：颜色值
struct Color {
    r: u8
    g: u8
    b: u8
    a: u8
}
```

### 何时使用类

- 数据量大
- 需要继承
- 需要引用语义（赋值时共享）
- 复杂的业务逻辑

---

## 完整示例

### 示例 1：二维向量

```q
struct Vector2 {
    x: f64
    y: f64
    
    func length() f64 {
        // 简化：不用 sqrt
        return this.x * this.x + this.y * this.y
    }
    
    func add(other: Vector2) Vector2 {
        return Vector2 {
            x: this.x + other.x,
            y: this.y + other.y
        }
    }
    
    func scale(factor: f64) Vector2 {
        return Vector2 {
            x: this.x * factor,
            y: this.y * factor
        }
    }
}

// 使用
var v1 = Vector2 { x: 1.0, y: 2.0 }
var v2 = Vector2 { x: 3.0, y: 4.0 }

var sum = v1.add(v2)
println(sum.x)  // 4.0
println(sum.y)  // 6.0

var scaled = v1.scale(2.0)
println(scaled.x)  // 2.0
println(scaled.y)  // 4.0
```

### 示例 2：矩形

```q
struct Rectangle {
    x: int
    y: int
    width: int
    height: int
    
    func area() int {
        return this.width * this.height
    }
    
    func perimeter() int {
        return 2 * (this.width + this.height)
    }
    
    func contains(px: int, py: int) bool {
        return px >= this.x && px < this.x + this.width &&
               py >= this.y && py < this.y + this.height
    }
}

var rect = Rectangle { x: 10, y: 20, width: 50, height: 30 }

println(rect.area())       // 1500
println(rect.perimeter())  // 160

if rect.contains(30, 35) {
    println("点在矩形内")
}
```

### 示例 3：RGB 颜色

```q
struct Color {
    r: u8
    g: u8
    b: u8
    
    func toHex() string {
        // 简化示例
        return "颜色转换"
    }
    
    func blend(other: Color, ratio: f64) Color {
        var r1 = this.r as f64
        var g1 = this.g as f64
        var b1 = this.b as f64
        
        var r2 = other.r as f64
        var g2 = other.g as f64
        var b2 = other.b as f64
        
        return Color {
            r: (r1 * ratio + r2 * (1.0 - ratio)) as u8,
            g: (g1 * ratio + g2 * (1.0 - ratio)) as u8,
            b: (b1 * ratio + b2 * (1.0 - ratio)) as u8
        }
    }
}

var red = Color { r: 255, g: 0, b: 0 }
var blue = Color { r: 0, g: 0, b: 255 }

var purple = red.blend(blue, 0.5)
```

---

## 最佳实践

1. **小型数据用结构体**：对于简单的数据聚合，优先使用结构体
2. **值语义明确**：理解结构体是值类型，赋值会复制
3. **避免大结构体**：大型数据结构应该使用类（引用类型）
4. **合理使用接口**：通过接口实现多态
5. **字段初始化完整**：确保所有字段都被初始化
6. **方法返回新实例**：对于修改操作，返回新的结构体实例而非修改 `this`

---

## 下一步

- 学习 [基本类型](./基本类型.md)
- 学习 [控制结构](./控制结构.md)
- 学习 [面向对象](./面向对象.md)
