# Q 语言教程 - 错误处理

## 目录

1. [异常处理概述](#异常处理概述)
2. [try-catch 语句](#try-catch-语句)
3. [throw 语句](#throw-语句)
4. [finally 块](#finally-块)
5. [异常类型](#异常类型)
6. [嵌套异常处理](#嵌套异常处理)
7. [最佳实践](#最佳实践)

---

## 异常处理概述

Q 语言使用 `try-catch-finally` 机制处理运行时错误。

### 为什么需要异常处理

```q
// 没有异常处理
var divide = func(a: int, b: int) int {
    return a / b  // 如果 b 为 0 会崩溃
}

// 有异常处理
var safeDivide = func(a: int, b: int) int {
    try {
        if b == 0 {
            throw "ArithmeticException: Division by zero"
        }
        return a / b
    } catch(e) {
        println("Error: " + e)
        return 0
    }
}
```

---

## try-catch 语句

### 基本语法

```q
try {
    // 可能抛出异常的代码
    var result = riskyOperation()
} catch(e) {
    // 异常处理代码
    println("Caught exception: " + e)
}
```

### 完整示例

```q
println("=== Basic try/catch ===")

try {
    println("Inside try block")
    throw "Exception: Simple error message"
    println("This will not execute")
} catch(e) {
    println("Caught exception:")
    println(e)
}

println("Program continues")
```

输出：
```
=== Basic try/catch ===
Inside try block
Caught exception:
Exception: Simple error message
Program continues
```

### 捕获并继续执行

```q
var result = 0

try {
    result = 10
    throw "RuntimeException: Error occurred"
    result = 20  // 不会执行
} catch(e) {
    result = 30
    println("Exception caught, result set to 30")
}

println(result)  // 30
```

---

## throw 语句

### 抛出异常

使用 `throw` 关键字抛出异常：

```q
throw "Exception: Error message"
```

### 异常格式

异常使用字符串表示，建议格式为 `"类型: 消息"`：

```q
throw "IOException: File not found"
throw "NullPointerException: Null value"
throw "IllegalArgumentException: Invalid input"
throw "ArithmeticException: Division by zero"
```

### 在函数中抛出异常

```q
var validateAge = func(age: int) {
    if age < 0 {
        throw "IllegalArgumentException: Age cannot be negative"
    }
    
    if age > 150 {
        throw "IllegalArgumentException: Age too large"
    }
    
    println("Age is valid")
}

try {
    validateAge(-5)
} catch(e) {
    println("Validation error: " + e)
}
```

### 条件抛出

```q
var divide = func(a: int, b: int) int {
    if b == 0 {
        throw "ArithmeticException: Division by zero"
    }
    return a / b
}

try {
    var result = divide(10, 0)
    println(result)
} catch(e) {
    println("Error: " + e)
}
```

---

## finally 块

`finally` 块中的代码无论是否发生异常都会执行。

### try-catch-finally

```q
try {
    println("Try block")
    throw "IllegalArgumentException: Invalid input"
} catch(e) {
    println("Catch block:")
    println(e)
} finally {
    println("Finally block (always executes)")
}
```

输出：
```
Try block
Catch block:
IllegalArgumentException: Invalid input
Finally block (always executes)
```

### finally 在正常执行时也运行

```q
try {
    println("Try block (no exception)")
} catch(e) {
    println("Catch block (should not execute)")
} finally {
    println("Finally block (still executes)")
}
```

输出：
```
Try block (no exception)
Finally block (still executes)
```

### finally 用于清理资源

```q
var processFile = func(filename: string) {
    var file: File? = null
    
    try {
        file = openFile(filename)
        // 处理文件
        println("Processing file")
    } catch(e) {
        println("Error processing file: " + e)
    } finally {
        // 确保文件被关闭
        if file != null {
            closeFile(file)
            println("File closed")
        }
    }
}
```

---

## 异常类型

Q 语言使用字符串表示异常，建议使用标准异常类型前缀：

### 常见异常类型

| 异常类型 | 说明 | 示例 |
|---------|------|------|
| `Exception` | 通用异常 | `"Exception: General error"` |
| `RuntimeException` | 运行时异常 | `"RuntimeException: Unexpected error"` |
| `IOException` | I/O 异常 | `"IOException: File not found"` |
| `NullPointerException` | 空指针异常 | `"NullPointerException: Null value"` |
| `IllegalArgumentException` | 非法参数异常 | `"IllegalArgumentException: Invalid input"` |
| `ArithmeticException` | 算术异常 | `"ArithmeticException: Division by zero"` |
| `IndexOutOfBoundsException` | 索引越界异常 | `"IndexOutOfBoundsException: Index 10 out of bounds"` |

### 使用示例

```q
// IOException
try {
    throw "IOException: File not found"
} catch(e) {
    println("Caught: " + e)
}

// ArithmeticException
try {
    throw "ArithmeticException: Division by zero"
} catch(e) {
    println("Caught: " + e)
}

// NullPointerException
try {
    throw "NullPointerException: Null value"
} catch(e) {
    println("Caught: " + e)
}
```

---

## 嵌套异常处理

### 嵌套 try-catch

```q
try {
    println("Outer try")
    
    try {
        println("Inner try")
        throw "NullPointerException: null value"
    } catch(innerE) {
        println("Inner catch: " + innerE)
        
        // 在内层 catch 中重新抛出异常
        throw "RuntimeException: Re-thrown from inner"
    }
} catch(outerE) {
    println("Outer catch: " + outerE)
}
```

输出：
```
Outer try
Inner try
Inner catch: NullPointerException: null value
Outer catch: RuntimeException: Re-thrown from inner
```

### 多层保护

```q
var complexOperation = func() {
    try {
        // 第一层操作
        try {
            // 第二层操作
            throw "IOException: Read error"
        } catch(e1) {
            println("Handling IO error")
            throw "RuntimeException: Failed to recover"
        }
    } catch(e2) {
        println("Final error handler: " + e2)
    }
}

complexOperation()
```

---

## panic 函数

`panic` 是内置函数，用于触发不可恢复的错误，终止程序：

```q
var criticalOperation = func() {
    var systemReady = false
    
    if !systemReady {
        panic("System not ready")
    }
    
    // 不会执行到这里
}

// criticalOperation()  // 会终止程序
```

### panic vs throw

- **throw**：可以被 catch 捕获，程序可以继续
- **panic**：不能被捕获，程序直接终止

```q
// throw - 可恢复
try {
    throw "Exception: Recoverable error"
} catch(e) {
    println("Recovered from: " + e)
}
println("Program continues")

// panic - 不可恢复
// panic("Fatal error")  // 程序终止
```

---

## 完整示例

### 示例 1：文件处理

```q
var readFile = func(filename: string) string {
    if filename == "" {
        throw "IllegalArgumentException: Filename cannot be empty"
    }
    
    try {
        // 模拟文件读取
        if filename == "nonexistent.txt" {
            throw "IOException: File not found: " + filename
        }
        
        return "File contents"
    } catch(e) {
        println("Error reading file: " + e)
        throw "IOException: Failed to read file"
    }
}

var processFile = func(filename: string) {
    try {
        var content = readFile(filename)
        println("File content: " + content)
    } catch(e) {
        println("Processing failed: " + e)
    } finally {
        println("Cleanup completed")
    }
}

processFile("nonexistent.txt")
```

### 示例 2：输入验证

```q
class Validator {
    static func validateEmail(email: string) {
        if email == "" {
            throw "IllegalArgumentException: Email cannot be empty"
        }
        
        // 简化的验证逻辑
        var hasAt = false
        for var i = 0; i < 0; i++ {  // 简化
            // 检查 @ 符号
        }
        
        if !hasAt {
            throw "IllegalArgumentException: Invalid email format"
        }
    }
    
    static func validateAge(age: int) {
        if age < 0 {
            throw "IllegalArgumentException: Age cannot be negative"
        }
        
        if age > 150 {
            throw "IllegalArgumentException: Age too large"
        }
    }
    
    static func validateUsername(username: string) {
        if username == "" {
            throw "IllegalArgumentException: Username cannot be empty"
        }
        
        // 长度检查（简化）
        if false {  // username.length() < 3
            throw "IllegalArgumentException: Username too short"
        }
    }
}

// 使用验证器
var registerUser = func(username: string, email: string, age: int) {
    try {
        Validator::validateUsername(username)
        Validator::validateEmail(email)
        Validator::validateAge(age)
        
        println("User registered successfully")
    } catch(e) {
        println("Registration failed: " + e)
    }
}

registerUser("", "invalid-email", -5)
```

### 示例 3：数学运算

```q
class SafeMath {
    static func divide(a: int, b: int) int {
        if b == 0 {
            throw "ArithmeticException: Division by zero"
        }
        return a / b
    }
    
    static func sqrt(n: int) int {
        if n < 0 {
            throw "ArithmeticException: Cannot calculate sqrt of negative number"
        }
        // 简化的平方根计算
        return 0
    }
    
    static func factorial(n: int) int {
        if n < 0 {
            throw "IllegalArgumentException: Factorial of negative number"
        }
        
        if n > 20 {
            throw "ArithmeticException: Result too large"
        }
        
        if n <= 1 {
            return 1
        }
        return n * SafeMath::factorial(n - 1)
    }
}

// 使用
try {
    var result1 = SafeMath::divide(10, 2)
    println(result1)  // 5
    
    var result2 = SafeMath::divide(10, 0)  // 抛出异常
} catch(e) {
    println("Math error: " + e)
}

try {
    var fact = SafeMath::factorial(5)
    println(fact)  // 120
} catch(e) {
    println("Factorial error: " + e)
}
```

---

## 最佳实践

### 1. 使用描述性的异常消息

```q
// 好：清晰的错误消息
throw "IOException: Cannot open file '/path/to/file.txt': Permission denied"

// 不好：模糊的错误消息
throw "Exception: Error"
```

### 2. 尽早失败

```q
// 好：参数验证在函数开头
var processUser = func(user: User?) {
    if user == null {
        throw "NullPointerException: User cannot be null"
    }
    
    // 继续处理...
}

// 不好：晚验证导致可能的部分执行
var processUser2 = func(user: User?) {
    // 一些操作...
    
    if user == null {  // 太晚了
        throw "NullPointerException: User cannot be null"
    }
}
```

### 3. finally 用于资源清理

```q
// 好：使用 finally 确保资源释放
try {
    var resource = acquireResource()
    useResource(resource)
} catch(e) {
    println("Error: " + e)
} finally {
    releaseResource(resource)  // 始终执行
}
```

### 4. 不要忽略异常

```q
// 不好：空的 catch 块
try {
    riskyOperation()
} catch(e) {
    // 什么都不做 - 隐藏了错误
}

// 好：至少记录异常
try {
    riskyOperation()
} catch(e) {
    println("Operation failed: " + e)
}
```

### 5. 适当的异常层级

```q
// 好：在适当的层次处理异常
class DataService {
    func getData() Data {
        try {
            return fetchFromDatabase()
        } catch(e) {
            // 转换为更高层的异常
            throw "ServiceException: Failed to retrieve data"
        }
    }
}
```

### 6. 文档化可能的异常

```q
// 好：注释说明可能抛出的异常
/// 打开文件
/// 
/// 可能抛出:
/// - IOException: 文件不存在
/// - IOException: 权限不足
var openFile = func(path: string) File {
    // 实现...
}
```

---

## 错误处理模式

### 1. 默认值模式

```q
var getConfigValue = func(key: string) string {
    try {
        return readConfig(key)
    } catch(e) {
        println("Using default value for " + key)
        return "default"
    }
}
```

### 2. 重试模式

```q
var retryOperation = func(maxAttempts: int) bool {
    for var attempt = 0; attempt < maxAttempts; attempt++ {
        try {
            performOperation()
            return true
        } catch(e) {
            println("Attempt " + attempt as string + " failed: " + e)
            
            if attempt == maxAttempts - 1 {
                println("All attempts failed")
                return false
            }
        }
    }
    return false
}
```

### 3. 回退模式

```q
var getData = func() Data {
    try {
        return getFromPrimarySource()
    } catch(e1) {
        println("Primary source failed, trying backup")
        
        try {
            return getFromBackupSource()
        } catch(e2) {
            println("Backup also failed, using cache")
            return getFromCache()
        }
    }
}
```

---

## 下一步

- 学习 [并发编程](./并发编程.md)
- 学习 [类型系统进阶](./类型系统进阶.md)
- 学习 [函数进阶](./函数进阶.md)
